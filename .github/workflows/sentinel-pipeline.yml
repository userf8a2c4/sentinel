# sentinel-pipeline.yml
# Pipeline de CI/CD para Sentinel - Ejecuta descarga, hash, normalización, análisis y pruebas
# CI/CD pipeline for Sentinel - Runs download, hash, normalization, analysis and tests

name: Sentinel Pipeline

on:
  push:
    branches: [main, dev, dev-v2, dev-v3]
  pull_request:
    branches: [main, dev, dev-v2, dev-v3]
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # Descarga el repositorio completo / Checks out the full repository

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.txt
        # Configura Python 3.11 para consistencia / Sets up Python 3.11 for consistency

      - name: Install lint dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black ruff
        # Instala dependencias de lint / Installs lint dependencies

      - name: Run black
        run: black --check .
        # Valida formato Black / Validates Black formatting

      - name: Run ruff
        run: ruff check .
        # Ejecuta Ruff / Runs Ruff

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # Descarga el repositorio completo / Checks out the full repository

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.txt
        # Configura Python 3.11 para consistencia / Sets up Python 3.11 for consistency

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        # Instala todas las dependencias del proyecto / Installs all project dependencies

      - name: Install Playwright browsers
        run: python -m playwright install --with-deps chromium
        # Instala Chromium para Playwright / Installs Chromium for Playwright

      - name: Run download and hash (mock mode in CI)
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: python -m scripts.download_and_hash --mock
        # Ejecuta el script de descarga con modo mock en CI para evitar errores de red
        # Runs download_and_hash script with mock mode in CI to avoid network errors

      - name: Run pytests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: pytest
        # Ejecuta pruebas unitarias / Runs unit tests
