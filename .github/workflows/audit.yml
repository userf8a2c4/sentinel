name: Vigilante Electoral Permanente

permissions:
  contents: write  # Necesario para commit y push
  actions: read    # Opcional, para leer workflow

on:
  workflow_dispatch:  # Permite ejecución manual
  schedule:
    - cron: '0 */3 * * *'  # Cada 3 horas (cambia a '*/30 * * * *' para pruebas cada 30 min)

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Para mantener historia git

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas  # Agrega pandas si lo usas en diffs

      - name: Ejecutar snapshot y hash
        run: python -m scripts.download_and_hash

      - name: Ejecutar diffs si aplica
        run: python scripts/calculate_diffs.py || echo "No hay suficientes snapshots para diffs"

      - name: Commit solo si hay cambios reales
        run: |
          git config user.name "AuditHN Bot"
          git config user.email "bot@audithn.org"

          git add data/ hashes/ diffs/ reports/

          if ! git diff --cached --quiet; then
            git commit -m "Actualización automática: snapshot y diffs $(date +'%Y-%m-%d %H:%M')"
            git pull --rebase origin main  # Actualiza para resolver behind
            git push origin main
          else
            echo "Sin cambios reales, no se commitea"
          fi

      - name: Enviar actualización a Telegram
        run: |
          python scripts/post_to_telegram.py "Actualización automática completada. Snapshot generado y hasheado. Ver repo: https://github.com/userf8a2c4/hnd-sentinel-2029"
